from matplotlib import pyplot as plt
from matplotlib.pyplot import gca

import numpy as np

other_months = ["June '12", "July", "August", "September", "October", "November", "December", "January '13", "February", "March"]

#modifications = 200

# Port 161
cisco = [0.10844736707518707, 0.09143639534087306, 0.03973883735287419, 0.03961157550199592, 0.0024048713613462297, 0.031961789579334904, 0.008492684725845339, 0.010606270784258647, 0.007871800067312983, 0.010412900352145475]
cisco_fr = 417
cisco_counts = [230961, 1798, 233589, 133108, 216031, 216607, 224118, 215669, 219342, 204296, 210290]

# SMTP
sendmail = [0.013319228079963307, 0.02344155653596725, 0.027731886769867445, 0.02166418230175329, 0.03219747688833537, 0.019062479414204504, 0.017730099837379915, 0.017104089131238565, 0.010665433456201178, 0.017074958303789068]
sendmail_fr = 510
sendmail_counts = [185164, 31443, 27902, 145481, 31187, 41258, 40298, 47038, 47954, 39294, 44214]

exim = [0.044765843784413076, 0.07466410474414399, 0.028333143249124833, 0.017535101993725582, 0.5801391463368014, 0.09950321829633538, 0.06685947673096608, 0.035123776326423356, 0.022957184186880624, 0.008088275723301874]
exim_fr = 1678
exim_counts = [732137, 123268, 114847, 567300, 142081, 231851, 223143, 260008, 254864, 207837, 209164]

# SSH
dropbear = [0.012057166526985907, 0.09752574867764933, 0.01755416853486813, 0.02910122221264114, 0.020805883913438347, 0.003823683747106063, 0.014540759571153243, 0.010520828396593115, 0.007536641665780163, 0.008968207370686602]
dropbear_fr = 3247
dropbear_counts = [878393, 146676, 177821, 627027, 199119, 382282, 380680, 406894, 424671, 359624, 392065]

openssh = [0.008654789407590046, 0.11278351924398028, 0.13284219039541725, 0.03102006450003128, 0.04835726775222799, 0.015122817315221148, 0.017732907614575237, 0.016052095514346176, 0.01514131334928638, 0.02482709393029328]
openssh_fr = 8003
openssh_counts = [4393687, 723230, 913234, 3131393, 955750, 1685322, 1640296, 1800849, 1820355, 1506234, 1600246]

freessh = [0.02525963852921647, 0.0658667209710742, 0.06532837449307988, 0.05714753178758414, 0.03803980506545248, 0.027767421580238823, 0.036137934731725004, 0.016636258393146565, 0.03241976254308695, 0.045953683171338626]
freessh_fr = 11
freessh_counts = [4096, 753, 763, 2674, 896, 1757, 1693, 1851, 1750, 1492, 1423]

def setup_plot():
    plt.grid(True, which="major", linestyle="dotted", axis="y", zorder=0)
    x = np.arange(len(other_months))
    plt.xticks(x, other_months, rotation=45, color='gray')
    plt.ylim((0, 1))
    plt.legend()
    gca().set_yticklabels(['{:.0f}%'.format(x * 100) for x in gca().get_yticks()])


def plot(data, data_counts, modifications, label):
    np_data = np.array(data)

    error = [modifications / n + modifications / c for n, c in zip(data_counts[1:], data_counts)]

    plt.plot(other_months, np_data, label=label)
    plt.fill_between(other_months, np_data - error, np_data + error, alpha=0.4)


# Plot mail servers
plot(sendmail, sendmail_counts, sendmail_fr, "Sendmail 8.x.x")
plot(exim, exim_counts, exim_fr, "Exim 4.x")
setup_plot()
plt.savefig("mail_servers_patch_rate.pdf", bbox_inches="tight", pad_inches=0.1)
plt.show()

# Plot SSH embedded vs commodity
plot(dropbear, dropbear_counts, dropbear_fr, "Dropbear _.x")
plot(openssh, openssh_counts, openssh_fr, "OpenSSH x.x")
plot(freessh, freessh_counts, freessh_fr, "FreeSSH x.x.x")
setup_plot()
plt.savefig("ssh_services_patch_rate.pdf", bbox_inches="tight", pad_inches=0.1)
plt.show()

# Plot Cisco (embedded operating system)
plot(cisco, cisco_counts, cisco_fr, "Cisco IOS x.x")
setup_plot()
plt.savefig("cisco_patch_rate.pdf", bbox_inches="tight", pad_inches=0.1)
plt.show()
