from collections import Counter
import datetime
import os
from matplotlib import pyplot as plt

import numpy as np

version_dates = {
    '28': '2003-04-06',
    '29': '2003-04-09',
    '30': '2003-04-17',
    '31': '2003-05-09',
    '32': '2003-05-24',
    '33': '2003-06-22',
    '34': '2003-08-15',
    '35': '2003-08-17',
    '36': '2003-08-19',
    '37': '2003-09-24',
    '38': '2003-10-11',
    '39': '2003-12-16',
    '40': '2004-01-13',
    '41': '2004-01-19',
    '42': '2004-06-16',
    '43': '2004-07-16',
    '44test1': '2004-08-16',
    '44test2': '2004-08-17',
    '44test3': '2004-08-27',
    '44test4': '2004-09-14',
    '44': '2005-01-03',
    '45': '2005-03-07',
    '46': '2005-07-08',
    '47': '2005-12-09',
    '48': '2006-03-09',
    '48.1': '2006-03-11',
    '49': '2007-02-22',
    '50': '2007-08-08',
    '51': '2008-03-27',
    '52': '2008-11-12',
    '53': '2011-02-24',
    '53.1': '2011-03-02',
    '54': '2011-11-08',
    '55': '2012-02-23',
    '56': '2013-03-21',
    '57': '2013-04-15',
}


def extract_dropbear_counts(month: str) -> Counter:
    discarded = set()
    discard_count = 0

    version_counter = Counter()
    total = 0

    try:
        file_nr = 0

        while True:
            filepath = os.path.join('..', 'processed_data', f'critical_{month}_22_{file_nr}.npz')
            arrays = np.load(filepath, allow_pickle=True)
            entries = arrays['arr_0']

            for entry in entries:
                if 'SSH-2.0-dropbear' not in entry['banner']:
                    continue

                dropbear_tag = entry['banner'][entry['banner'].find('SSH-2.0-dropbear')+17:]
                dropbear_tag = dropbear_tag.split()[0]
                dropbear_tag = dropbear_tag[dropbear_tag.find('.') + 1:]

                if dropbear_tag not in version_dates:
                    discarded.add(dropbear_tag)
                    discard_count += 1
                    continue

                version_counter[dropbear_tag] += 1
                total += 1

            file_nr += 1
    except FileNotFoundError:
        pass

    print(f"Counted {total} DropBear services and discarded another {discard_count}")
    print(f"Counted: {version_counter}")
    print(f"Discarded: {discarded}")

    return version_counter


if __name__ == '__main__':
    counter = extract_dropbear_counts('201205')

    # Plot of version distribution
    x = np.arange(len(version_dates))
    data = [counter[key] if key in counter else 0 for key in version_dates]

    plt.bar(x, data)
    plt.xticks(x, version_dates.keys(), rotation='vertical', color='gray')
    plt.show()

    # Plot of version date distribution
    x = [datetime.datetime.strptime(v, '%Y-%m-%d') for v in version_dates.values()]

    plt.bar(x, data, width=50)
    plt.xticks(x, version_dates.keys(), rotation='vertical', color='gray')
    plt.show()
