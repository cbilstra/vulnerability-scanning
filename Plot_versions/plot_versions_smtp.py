from collections import Counter
import re
import os
from matplotlib import pyplot as plt
import numpy as np
import collections


def find(s, ch):
    return [i for i, ltr in enumerate(s) if ltr == ch]


discarded = set()
discard_count = 0

counter = Counter()
total = 0

for file_nr in range(1):
    file_string = f'critical_201205_25_{file_nr}.npz'
    filepath = os.path.join('..', 'processed_data', file_string)
    arrays = np.load(filepath, allow_pickle=True)
    entries = arrays['arr_0']

    for entry in entries:
        cisco_banner = ''
        input_banner = entry['banner']

        if 'Sendmail' in input_banner:
            matches = re.findall("Sendmail [0-9]+\.[0-9]+\.[0-9]+", input_banner)
            if len(matches) > 0:
                result = matches[0][9:]

                if not result.startswith('8'):
                    continue

                counter[float(result[2:])] += 1
                total += 1

        # matches = re.findall("Version [0-9]+\.[0-9A-Za-z()]*", input_banner)
        # if len(matches) > 0:
        #     result = find(matches[0], '.')
        #     version = matches[0][8:result[0]+2]
        #     cisco_banner = float(version)
        #
        #     counter[cisco_banner] += 1
        #     total += 1

print(f"Counted {total} smtp services and discarded another {discard_count}")
print(f"Counted: {counter}")
print(f"Discarded: {discarded}")

# Plot of version distribution
x = counter.keys()
y = counter.values()

plt.bar(x, y, width=0.1)
plt.xticks(np.arange(min(x), max(x)+0.1, 0.5), rotation='vertical', color='gray')
plt.show()

# show only first 20 versions
# od = collections.OrderedDict(sorted(counter.items()))
# x = list(od.keys())
# y = list(od.values())
# x = x[:20]
# y = y[:20]
#
# plt.bar(x, y, width=0.1)
# plt.xticks(np.arange(min(x), max(x)+0.1, 0.25), rotation='vertical', color='gray')
# plt.show()
