from collections import Counter
import collections
import datetime
import os
from matplotlib import pyplot as plt

import numpy as np
import re

search_pattern = re.compile(r'SSH-2\.0-WeOnlyDo (?P<version>[\w.]+)')


def extract_openssh_counts(month: str) -> Counter:
    discarded = set()
    discard_count = 0

    version_counter = Counter()
    total = 0

    try:
        file_nr = 0

        while True:
            filepath = os.path.join('..', 'processed_data', f'critical_{month}_22_{file_nr}.npz')
            arrays = np.load(filepath, allow_pickle=True)
            entries = arrays['arr_0']

            for entry in entries:
                openssh_tag = None
                input_banner = entry['banner']
                split = input_banner.split("_")

                if len(split) <= 1:
                    continue

                check = split[1]
                if not check:
                    continue
                else:
                    try:
                        first_num = check[0]
                        if check[1] != '.':
                            openssh_tag = first_num

                        second_num = int(check[2])
                    except Exception as e:
                        continue

                if not openssh_tag:
                    openssh_tag = split[1][:3]

                if not '.' in openssh_tag:
                    discard_count += 1
                    discarded.add(openssh_tag)
                    continue
                elif '.' == openssh_tag:
                    discard_count += 1
                    discarded.add(openssh_tag)
                    continue

                version_counter[openssh_tag] += 1
                total += 1

            file_nr += 1
    except FileNotFoundError:
        pass

    print(f"Counted {total} openssh services and discarded another {discard_count}")
    print(f"Counted: {version_counter}")
    print(f"Discarded: {discarded}")

    return version_counter


if __name__ == '__main__':
    counter = extract_openssh_counts('201208')

    ordered = collections.OrderedDict(sorted(counter.items()))
    x = [str(i) for i in ordered.keys()]
    y = list(ordered.values())

    plt.bar(x, y, width=0.1)
    plt.xticks(x, rotation='vertical', color='gray')
    plt.yscale('log')
    plt.show()
