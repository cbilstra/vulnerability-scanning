from collections import Counter
import re
import os
from matplotlib import pyplot as plt
import numpy as np


def find(s, ch):
    return [i for i, ltr in enumerate(s) if ltr == ch]


filepath = os.path.join('..', 'processed_data', 'critical_201301_3306_0.npz')
arrays = np.load(filepath, allow_pickle=True)
entries = arrays['arr_0']

discarded = set()
discard_count = 0

counter = Counter()
total = 0

for entry in entries:
    mysql_tag = 10
    input_banner = entry['banner']
    matches = re.findall("[0-9]+\.[0-9]+\.[0-9]+-[0-9A-Za-z]*", input_banner)
    if len(matches) > 0:
        result = find(matches[0], '.')
        mysql_tag = float(matches[0][:result[1]])

    if mysql_tag > 8:
        discarded.add(mysql_tag)
        discard_count += 1
        continue

    counter[mysql_tag] += 1
    total += 1

print(f"Counted {total} mysql services and discarded another {discard_count}")
print(f"Counted: {counter}")
print(f"Discarded: {discarded}")


# Plot of version distribution
x = counter.keys()
y = counter.values()

plt.bar(x, y, width=0.1)
plt.xticks(x, rotation='vertical', color='gray')
plt.show()
