from collections import Counter
import collections
import datetime
import os
from matplotlib import pyplot as plt

import numpy as np
import re

search_pattern = re.compile(r'SSH-2\.0-WeOnlyDo (?P<version>[\w.]+)')


def extract_freesshd_counts(month: str) -> Counter:
    discarded = set()
    discard_count = 0

    version_counter = Counter()
    total = 0

    try:
        file_nr = 0

        while True:
            filepath = os.path.join('..', 'processed_data', f'critical_{month}_22_{file_nr}.npz')
            arrays = np.load(filepath, allow_pickle=True)
            entries = arrays['arr_0']

            for entry in entries:

                banner = entry['banner']
                freesshd_tag = search_pattern.search(banner)
                if not freesshd_tag:
                    continue
                # openssh_tag.group('version')
                freesshd_tag = freesshd_tag[0]
                freesshd_tag = freesshd_tag.split(' ')[1]

                version_counter[freesshd_tag] += 1
                total += 1

            file_nr += 1
    except FileNotFoundError:
        pass

    print(f"Counted {total} DropBear services and discarded another {discard_count}")
    print(f"Counted: {version_counter}")
    print(f"Discarded: {discarded}")

    return version_counter


if __name__ == '__main__':
    counter = extract_freesshd_counts('201208')

    ordered = collections.OrderedDict(sorted(counter.items()))
    x = [str(i) for i in ordered.keys()]
    y = list(ordered.values())

    plt.bar(x, y, width=0.1)
    plt.xticks(x, rotation='vertical', color='gray')
    plt.yscale('log')
    plt.show()
